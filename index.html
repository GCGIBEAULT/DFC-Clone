<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DFC Minimal</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 24px; color:#111 }
    #lines { display:flex; flex-direction:column; gap:8px; margin-top:12px; max-width:760px }
    .line { display:flex; gap:8px; align-items:center; padding:8px; border:1px solid #e6e6e6; border-radius:6px }
    input[type="text"], input[type="number"], select { padding:6px 8px; border:1px solid #ddd; border-radius:4px }
    button { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fafafa; cursor:pointer }
  </style>
</head>
<body>
  <h1>Digging For Clarity — Minimal</h1>
  <div>
    <strong>IOIOIO 1st 15th</strong>
    <div style="margin-top:8px">
      Income $ <span id="income">0</span>
      &nbsp;&nbsp;Expenses $ <span id="exp">0</span>
      &nbsp;&nbsp;<button id="add-line">+ Add line</button>
    </div>
  </div>

  <div id="lines" aria-live="polite"></div>

  <script>
    // ===== KEY / defaults / state =====
    const KEY = 'dfc:blank:ioioio:v1';
    const defaults = {
      active: '1',
      paychecks: {
        '1': { income: 1800, lines: [
          { id:'r1', name:'Rent', amount:700, type:'auto', vendor_url:'' },
          { id:'r2', name:'Electric', amount:80, type:'auto', vendor_url:'' },
          { id:'r3', name:'Savings', amount:200, type:'auto', vendor_url:'' }
        ] }
      }
    };

    let state = null;

    // ===== persistence =====
    function saveState(){
      try { localStorage.setItem(KEY, JSON.stringify(state)); } catch(e){ console.error('saveState', e) }
    }

    function loadState(){
      try {
        const raw = localStorage.getItem(KEY);
        if(!raw) { state = JSON.parse(JSON.stringify(defaults)); saveState(); return state; }
        state = JSON.parse(raw);
        // Ensure canonical defaults exist for active pay period (idempotent)
        const pay = state.paychecks[state.active] || { income: 0, lines: [] };
        state.paychecks[state.active] = pay;
        const names = pay.lines.map(l => l.name);
        // canonical seed (keeps contained defaults under state)
        const canonical = defaults.paychecks[defaults.active].lines;
        canonical.forEach(b => { if(!names.includes(b.name)) pay.lines.push(JSON.parse(JSON.stringify(b))); });
        saveState();
        return state;
      } catch(e){
        state = JSON.parse(JSON.stringify(defaults));
        saveState();
        return state;
      }
    }

    // ===== render =====
    function render(){
      const pay = state.paychecks[state.active];
      const container = document.getElementById('lines');
      container.innerHTML = '';
      document.getElementById('income').textContent = pay.income;
      let total = 0;

      pay.lines.forEach((line, idx) => {
        total += Number(line.amount) || 0;
        const el = document.createElement('div');
        el.className = 'line';
        el.dataset.id = line.id;
        el.innerHTML = `
          <input type="text" class="name" value="${escapeHtml(line.name)}" style="flex:1" />
          <input type="number" class="amt" value="${Number(line.amount)}" style="width:110px" />
          <select class="type" style="width:110px">
            <option value="auto" ${line.type === 'auto' ? 'selected' : ''}>Auto</option>
            <option value="offline" ${line.type === 'offline' ? 'selected' : ''}>Offline</option>
          </select>
          <button class="rem" title="Remove">✕</button>
        `;
        // Wire events per-line
        const nameEl = el.querySelector('.name');
        const amtEl = el.querySelector('.amt');
        const typeEl = el.querySelector('.type');
        const remEl = el.querySelector('.rem');

        nameEl.addEventListener('input', () => { line.name = nameEl.value; saveState(); });
        amtEl.addEventListener('input', () => { line.amount = Number(amtEl.value) || 0; saveState(); render(); });
        typeEl.addEventListener('change', () => { line.type = typeEl.value; saveState(); });
        remEl.addEventListener('click', () => {
          pay.lines = pay.lines.filter(l => l.id !== line.id);
          saveState();
          render();
        });

        container.appendChild(el);
      });

      document.getElementById('exp').textContent = total;
    }

    // ===== helpers =====
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // ===== addLine (single, reliable) =====
    function addLine(){
      const id = 'n' + Date.now().toString(36);
      const pay = state.paychecks[state.active];
      const newLine = { id, name: 'New item', amount: 0, type: 'offline', vendor_url: '' };
      pay.lines.push(newLine);
      saveState();
      render();
      // focus the new line's name field after render
      setTimeout(() => {
        const el = document.querySelector(`#lines .line[data-id="${id}"] .name`);
        if(el) el.focus();
      }, 0);
    }

    // ===== boot =====
    document.getElementById('add-line').addEventListener('click', addLine);

    // Initialize once, single source of truth
    loadState();
    render();
  </script>
</body>
</html>
