<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Digging For Clarity â€” Private Lab</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .line { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    input.name { width: 100%; }
    input.amt { width: 100%; text-align: right; }
    select.type { width: 100%; }
    button.url, button.rem { width: 100%; }
  </style>
</head>
<body>
  <h1>IOIOIO</h1>
  <div>
    <label>Income $ <input type="number" id="incomeInput"></label>
  </div>
  <div id="lines"></div>
  <button onclick="addLine()">+ Add line</button>
  <div id="totals" style="margin-top:20px;font-weight:bold"></div>

  <script>
    const $ = sel => document.querySelector(sel);
    let state = {
      paychecks: [{ income: 1800, lines: [] }],
      active: 0
    };

    function saveState() {
      localStorage.setItem('dfc_state', JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem('dfc_state');
      if (raw) state = JSON.parse(raw);
    }

    function renderTotals() {
      const pay = state.paychecks[state.active];
      const total = pay.lines.reduce((sum, line) => sum + line.amount, 0);
      $('#totals').textContent = `Expenses $${total} â€¢ Leftover $${pay.income - total}`;
    }

    function render() {
      const pay = state.paychecks[state.active];
      $('#incomeInput').value = Math.round(pay.income);
      const linesEl = $('#lines');
      linesEl.innerHTML = '';

      pay.lines.forEach(line => {
        const el = document.createElement('div');
        el.className = 'line';
        el.innerHTML = `
          <div style="flex:1">
            <input value="${escape(line.name)}" data-id="${line.id}" class="name">
          </div>
          <div style="width:110px;text-align:right">
            <input type="number" value="${line.amount}" data-id="${line.id}" class="amt">
          </div>
          <div style="width:90px">
            <select class="type" data-id="${line.id}">
              <option value="auto"${line.type === 'auto' ? ' selected' : ''}>Auto</option>
              <option value="offline"${line.type === 'offline' ? ' selected' : ''}>Offline</option>
            </select>
          </div>
          <div style="width:36px;text-align:center">
            <button class="url" data-id="${line.id}">${line.vendor_url ? 'ðŸ”—' : '+'}</button>
          </div>
          <div style="width:36px;text-align:center">
            <button class="rem" data-id="${line.id}">âœ•</button>
          </div>
        `;
        linesEl.appendChild(el);

        el.querySelector('.name').addEventListener('change', e => {
          line.name = e.target.value;
          saveState();
          renderTotals();
        });

        el.querySelector('.amt').addEventListener('change', e => {
          line.amount = Number(e.target.value) || 0;
          saveState();
          renderTotals();
        });

        el.querySelector('.type').addEventListener('change', e => {
          line.type = e.target.value;
          saveState();
          renderTotals();
        });

        el.querySelector('.url').addEventListener('click', () => {
          const url = prompt('Vendor URL (billing page or contact)', line.vendor_url || '');
          if (url === null) return;
          line.vendor_url = url.trim();
          saveState();
          render();
        });

        el.querySelector('.rem').addEventListener('click', () => {
          if (confirm('Remove this line?')) {
            state.paychecks[state.active].lines = state.paychecks[state.active].lines.filter(l => l.id !== line.id);
            saveState();
            render();
          }
        });
      });

      renderTotals();
    }

    function addLine() {
      const pay = state.paychecks[state.active];
      const id = Date.now();
      pay.lines.push({
        id: id,
        name: 'New item',
        amount: 0,
        type: 'offline',
        vendor_url: ''
      });
      saveState();
      render();
    }

    loadState();
    render();
  </script>
</body>
</html>
