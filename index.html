<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Digging For Clarity — Private Lab</title>
<link rel="icon" href="footer_logo.png" type="image/png">
<link rel="stylesheet" href="style.css">
<style>
:root{--bg:#f6f7f9;--card:#fff;--accent:#003366;--muted:#6b7280}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Georgia,serif;background:var(--bg);margin:0;color:#0b1220}
.wrap{max-width:960px;margin:0 auto;padding:20px}
.masthead{text-align:center;margin-top:28px}
.masthead h1{font-family:Georgia,serif;color:var(--accent);font-size:2.4rem;margin:0}
.masthead p{color:var(--muted);margin:6px 0 18px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
.card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 4px 14px rgba(7,12,20,0.06)}
.small{font-size:0.95rem;color:var(--muted)}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
.paytabs{display:flex;gap:8px;margin-bottom:12px}
.tab{padding:6px 10px;border-radius:6px;background:#eef2f7;color:#003366;cursor:pointer}
.tab.active{background:#003366;color:#fff}
.line{display:flex;gap:8px;align-items:center;padding:8px;border:1px solid #eee;border-radius:6px;background:#fff}
.line input[type="text"], .line input[type="number"]{border:1px solid #ddd;padding:6px;border-radius:4px}
.amt.empty{color:#9CA3AF}
</style>
</head>
<body>
<div class="wrap">
  <header class="masthead">
    <h1>Digging For Clarity — Private Lab</h1>
    <p class="small">Private workspace • Local-first testing</p>
  </header>

  <main style="margin-top:18px" role="main">
    <div class="card" id="primaryCard">
      <h2 style="margin:0 0 8px;color:var(--accent)">IOIOIO</h2>

      <div id="budgetRoot" aria-live="polite">
        <div class="paytabs" role="tablist" aria-label="Pay periods">
          <div class="tab active" data-pay="1" onclick="switchPay('1')">1st</div>
          <div class="tab" data-pay="15" onclick="switchPay('15')">15th</div>
        </div>

        <!-- Row 1 -->
        <div style="display:flex;gap:12px;align-items:center">
          <div style="display:flex;flex-direction:column;gap:6px">
            <label class="small" style="font-weight:700">Income</label>
            <div style="padding:8px 12px;background:#f4f6f8;border-radius:8px;display:flex;align-items:center;gap:8px;min-width:140px">
              <span style="color:var(--muted);font-size:0.95rem">$</span>
              <input type="number" id="incomeVal" value="1800" style="width:84px;height:28px;border:0;background:transparent;outline:none;font-size:15px;">
            </div>
          </div>

          <div style="display:flex;flex-direction:column;gap:6px;margin-left:12px">
            <label class="small" style="font-weight:700">Expenses</label>
            <div id="expensesVal" class="small" style="padding:8px 12px;background:#f4f6f8;border-radius:8px;min-width:120px">$0</div>
          </div>
        </div>

        <!-- Row 2: lines container and Add button -->
        <div style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0;color:var(--accent)">Lines</h3>
            <button class="btn" onclick="addLine()">+ Add line</button>
          </div>

          <div id="lines" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;"></div>
        </div>

        <footer style="margin-top:16px">
          <div class="small">Private workspace • Local-first testing • Your backup is safe</div>
        </footer>
      </div>
    </div>
  </main>
</div>

<script>
/* single main script block — preserves KEY/defaults and UX improvements */
const KEY = 'dfc:blank:ioioio:v1';
const defaults = {
  active: '1',
  paychecks: {
    '1': { income: 1800, lines: [ { id: 'r1', name: 'Rent', amount: 700, type: 'auto', vendor_url: '' } ] },
    '15': { income: 1800, lines: [] }
  }
};

let state = loadState();

function loadState(){
  try {
    const raw = localStorage.getItem(KEY);
    if(!raw) return JSON.parse(JSON.stringify(defaults));
    return Object.assign(JSON.parse(JSON.stringify(defaults)), JSON.parse(raw));
  } catch(e) { return JSON.parse(JSON.stringify(defaults)); }
}

function saveState(){
  try { localStorage.setItem(KEY, JSON.stringify(state)); } catch(e){}
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function switchPay(payId){
  state.active = payId;
  saveState();
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-pay')===payId));
  render();
}

function render(){
  const pay = state.paychecks[state.active];
  const incomeEl = document.getElementById('incomeVal');
  if(incomeEl) incomeEl.value = pay.income;
  const total = pay.lines.reduce((s,l)=> s + (Number(l.amount)||0), 0);
  const expensesEl = document.getElementById('expensesVal');
  if(expensesEl) expensesEl.textContent = `$${total}`;

  const container = document.getElementById('lines');
  if(!container) return;
  container.innerHTML = '';
  pay.lines.forEach(line => {
    const div = document.createElement('div');
    div.className = 'line';

    // Name: if empty show visible placeholder "New item"
    const nameVal = line.name ? escapeHtml(line.name) : '';
    const namePlaceholder = line.name ? 'Enter bill name' : 'New item';

    // Amount: if zero show empty input with muted placeholder
    const amtIsZero = (Number(line.amount) || 0) === 0;
    const amtVal = amtIsZero ? '' : escapeHtml(line.amount);
    const amtPlaceholder = amtIsZero ? 'enter cost' : '';

    div.innerHTML = `
      <input type="text" class="name" value="${nameVal}" placeholder="${namePlaceholder}" data-id="${line.id}" aria-label="Bill name" />
      <input type="number" class="amt ${amtIsZero ? 'empty' : ''}" value="${amtVal}" placeholder="${amtPlaceholder}" style="width:90px" data-id="${line.id}" aria-label="Bill amount" />
      <button class="btn small" onclick="removeLine('${line.id}')" style="padding:4px 8px">Remove</button>
    `;
    container.appendChild(div);

    const nameInput = div.querySelector('.name');
    const amtInput = div.querySelector('.amt');

    if(amtInput && amtInput.value === '') {
      amtInput.classList.add('empty');
      amtInput.style.color = '#9CA3AF';
      amtInput.title = 'Click to add cost';
    } else if(amtInput) {
      amtInput.classList.remove('empty');
      amtInput.style.color = '';
      amtInput.title = 'Enter cost';
    }

    if(nameInput) {
      nameInput.addEventListener('input', (e)=> {
        const id=e.target.dataset.id;
        const L = findLine(id);
        if(L){ L.name = e.target.value; saveState(); }
      });
    }

    if(amtInput) {
      amtInput.addEventListener('input', (e)=> {
        const id=e.target.dataset.id;
        const L = findLine(id);
        if(L){
          const v = e.target.value;
          L.amount = v === '' ? 0 : Number(v) || 0;
          saveState();
          const totalNow = state.paychecks[state.active].lines.reduce((s,l)=> s + (Number(l.amount)||0), 0);
          const expensesEl2 = document.getElementById('expensesVal');
          if(expensesEl2) expensesEl2.textContent = `$${totalNow}`;
          if(e.target.value === '') { e.target.classList.add('empty'); e.target.style.color = '#9CA3AF'; e.target.title = 'Click to add cost'; }
          else { e.target.classList.remove('empty'); e.target.style.color = ''; e.target.title = 'Enter cost'; }
        }
      });
      amtInput.addEventListener('blur', (e)=> {
        const id=e.target.dataset.id;
        const L = findLine(id);
        if(L){
          if(e.target.value === '') { L.amount = 0; saveState(); render(); }
        }
      });
    }
  });
}

function findLine(id){
  const pay = state.paychecks[state.active];
  return pay.lines.find(l => l.id === id);
}

function removeLine(id){
  const pay = state.paychecks[state.active];
  pay.lines = pay.lines.filter(l => l.id !== id);
  saveState();
  render();
}

/* addLine inside main script; works for active pay period (1 or 15) */
function addLine() {
  const pay = state.paychecks[state.active];
  const id = 'n' + Date.now().toString(36);
  pay.lines.push({
    id: id,
    name: '',
    amount: 0,
    type: 'offline',
    vendor_url: '',
    comment: '',
    pay_date: ''
  });
  saveState();
  render();

  // focus the new name input so user immediately sees it's editable
  setTimeout(() => {
    const el = document.querySelector(`#lines .line:last-child .name`);
    if(el) { el.focus(); el.select && el.select(); }
  }, 20);
}

/* preserved helper */
function openLocalNews(){
  const el = document.getElementById('localNews');
  const url = el && el.value && el.value.trim();
  if(!url){ alert('Enter a valid local news URL first.'); return; }
  localStorage.setItem('dfc:local',url);
  window.open(url,'_blank');
}

document.addEventListener('DOMContentLoaded',() => {
  const saved = localStorage.getItem(KEY);
  if(saved) {
    try { state = Object.assign(JSON.parse(JSON.stringify(defaults)), JSON.parse(saved)); } catch(e){}
  }
  const income = document.getElementById('incomeVal');
  if(income){
    income.addEventListener('change', () => {
      const pay = state.paychecks[state.active];
      pay.income = Number(income.value) || 0;
      saveState();
      render();
    });
  }
  render();
});
</script>
</body>
</html>
